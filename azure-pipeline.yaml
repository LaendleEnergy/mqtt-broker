parameters:
- name: deploy
  displayName: Deloy Buildartifact
  type: boolean
  default: false
- name: dockerfiles
  type: object
  default:
    - name: "Broker"
      file: "./eclipse-mosquitto/Dockerfile"
    - name "Second"
      file: "./eclipse-mosquitto/Dockerfile"

variables:
  remoteProjectPath: /home/felix/projects/mqtt_broker

trigger:
  branches:
    include:
      - master

pool:
  vmImage: ubuntu-latest

stages:
- stage: build_test
  displayName: Build Image
  jobs:
  - ${{ each file in parameters.dockerfiles }}:
    - job: build
      displayName: Build $ {{ file.name }}-Image
      steps:
      - task: Docker@2
        displayName: Build Image
        inputs:
          command: build
          dockerfile: ${{ file.file }}
- stage: deploy
  condition: eq('${{ parameters.deploy }}', true)
  displayName: deploy to Domonik's Server ;-)
  jobs:
  - job: copy_files_and_docker_up
    displayName: copy Files to Server and start with docker compose
    steps:
    - task: CopyFilesOverSSH@0
      displayName: Copy Project to Server
      inputs:
        sshEndpoint: '71430-33034_ssh'
        contents: '**'
        cleanTargetFolder: true
        cleanHiddenFilesInTarget: true
        overwrite: true
        targetFolder: $(remoteProjectPath)
        isWindowsOnTarget: false
        readyTimeout: '20000'
    - task: SSH@0
      displayName: docker compose up
      inputs:
        sshEndpoint: '71430-33034_ssh'
        runOptions: 'commands'
        commands: 'docker compose -f ${{ variables.remoteProjectPath }}/docker-compose.yaml --progress quiet up -d --force-recreate'
        readyTimeout: '20000'