parameters:
- name: deploy
  displayName: Deloy Buildartifact
  type: boolean
  default: false

variables:
  remoteProjectPath: /home/felix/projects/mqtt_broker
  sshEndpoint: 71430-33034
  dockerfile: ./eclipse-mosquitto/Dockerfile

trigger:
  branches:
    include:
      - master

pool:
  vmImage: ubuntu-latest

stages:
- stage: build_test
  displayName: Build Image
  jobs:
  - job: build
    displayName: Build
    steps:
    - task: Docker@2
      displayName: Build Image
      inputs:
        command: build
        dockerfile: $(dockerfile)
- stage: deploy
  condition: eq('${{ parameters.deploy }}', true)
  displayName: deploy to Domonik's Server ;-)
  jobs:
  - job: copy_files_and_docker_up
    displayName: copy Files to Server and start with docker compose
    steps:
    - task: DockerCompose@0
      inputs:
        containerregistrytype: 'Azure Container Registry'
        dockerComposeFile: '**/docker-compose.yml'
        action: 'Run a Docker Compose command'
        dockerComposeCommand: 'up'
        arguments: '-d --force-recreate'
        dockerHostEndpoint: '71430-33034_docker-host'
        currentWorkingDirectory: '$(remoteProjectPath)'
    